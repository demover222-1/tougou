<!DOCTYPE html>
<html lang="ja">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>予約システム</title>
</head>


<body>
<!-- 背景専用レイヤー -->
<div id="bg-layer">
  <img id="bg-image" src="" alt="">
</div>


	
<div id="menu-page" class="page active">
  <h2>メニューを選択してください</h2>
  <div id="menu-container">読み込み中...</div>
</div>

<div id="staff-page" class="page">
  <h2>スタッフを選択してください</h2>
  <div id="staff-container" class="staff-list">読み込み中...</div>
</div>

<div id="calendar-page" class="page">
  <h1>予約したい日時を<br>選択してください</h1>
  <div id="month-navigation">
    <button class="nav-btn" id="prev-month-btn">← 前の月</button>
    <span id="current-month-label"></span>
    <button class="nav-btn" id="next-month-btn">次の月 →</button>
  </div>
  <div id="calendar"></div>
  <div id="times-list">
    <h2 id="selected-date-title"></h2>
    <div id="time-slots-container"></div>
  </div>
  <div id="selected-info">現在読み込み中です。<br>カレンダーが表示されるまでお待ちください。</div>
</div>

<!-- 要望入力ページ -->
<div id="request-page" class="page">
  <h2>ご要望・メッセージがあればご記入ください</h2>
  <textarea id="request-text" rows="5" placeholder="例：前回と同じスタイルでお願いします。"></textarea>
</div>

	<div id="completion-page">
		<div class="completion-box">	
			予約が完了しました！<br>ご来店をお待ちしております。
		</div>
	</div>

<div class="action-bar">
  <button id="menu-next" disabled>次へ</button>
  <button id="staff-next" disabled>次へ</button>
  <button id="calendar-next" disabled>次へ</button>
  <button id="send-button" disabled>予約を送信する</button>
  <button id="back-button">戻る</button>
</div>

<script>
const postwebhookURL = "https://reservations.demover222.workers.dev/";
const webhookURL = "https://reservations.demover222.workers.dev/";
const urlParams = new URLSearchParams(window.location.search);
const userId = urlParams.get("userId");
const webappurl = urlParams.get("webappurl");
const sheetId = urlParams.get("sheetId");
const isHenkou = urlParams.get("henkou") === "true";

//CSS関連全て～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～
window.onload = function() {
  // CSS 読み込み
  const cssFile = urlParams.get("css") || "style.css";
  const link = document.createElement("link");
  link.rel = "stylesheet";
  link.href = cssFile;
  document.head.appendChild(link);

  // カスタムカラー設定
  const root = document.documentElement;
	const colorMap = {
				colorHeading: "--color-heading",
				bgSelected: "--bg-selected",
				bgCardCommon: "--bg-card-common",
				colorSlotStringCommon: "--color-slot-string-common",
				
				colorButtonString: "--color-button-string",
				bgDisabledButton: "--bg-disabled-button",
				bgHighlight: "--bg-highlight",
				
				colorBlockTitle: "--color-block-title",
				colorMenuItemString: "--color-menu-item-string",
				colorMenuDescString: "--color-menu-desc-string",
				
				colorStaffName: "--color-staff-name",
				colorStaffLabel: "--color-staff-label",
				colorStaffExp: "--color-staff-exp",
				
				colorDayString: "--color-day-string",
				bgTimeSlot: "--bg-time-slot",
				bgUnavailableSlots: "--bg-unavailable-slots"
	};

  for (const key in colorMap) {
    if (urlParams.get(key)) root.style.setProperty(colorMap[key], urlParams.get(key));
  }

//～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～
  //　--- 背景画像設定 --- //
const bgImageParam = urlParams.get("bgimage");
const bgImage = document.getElementById("bg-image");

if (bgImageParam && bgImageParam.trim() !== "") {
  bgImage.src = bgImageParam;
} else {
  if (cssFile === "style_huwa.css") {
    bgImage.src = "background-huwa.jpg";
  } else if (cssFile === "style_luxury.css") {
    bgImage.src = "background-luxury.jpg";
  } else {
    bgImage.src = "background.jpg";
  }
}

 //～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～
  



//～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～

let selectedMenu = null;
let selectedStaff = null;
let selectedDayDiv = null;
let duration = 30;
let reservedSlots = [];



// ここに追加
let startHour, startMinute, endHour, endMinute;






















const menuContainer = document.getElementById("menu-container");
const menuNextBtn = document.getElementById("menu-next");
const staffContainer = document.getElementById("staff-container");
const staffNextBtn = document.getElementById("staff-next");
const calendarDiv = document.getElementById("calendar");
const currentMonthLabel = document.getElementById("current-month-label");
const prevBtn = document.getElementById("prev-month-btn");
const nextBtn = document.getElementById("next-month-btn");
const timesList = document.getElementById("times-list");
const slotsContainer = document.getElementById("time-slots-container");
const selectedInfo = document.getElementById("selected-info");
const sendBtn = document.getElementById("send-button");
const completionPage = document.getElementById("completion-page");

let displayedYear, displayedMonth;

 // 初期ボタン表示設定
menuNextBtn.style.display = "block";    // 最初は「次へ」のみ表示
staffNextBtn.style.display = "none";
sendBtn.style.display = "none";
document.getElementById("back-button").style.display = "none";

// ---------- ページ遷移 ----------
const pages = ["menu-page", "staff-page", "calendar-page", "request-page"];
let currentPageIndex = 0; // 現在ページ

function showPage(index){
  pages.forEach((p,i)=>document.getElementById(p).classList.toggle("active",i===index));
  currentPageIndex = index;
  
  menuNextBtn.style.display = index===0 ? "block" : "none";
  staffNextBtn.style.display = index===1 ? "block" : "none";
  document.getElementById("calendar-next").style.display = index===2 ? "block" : "none";
  sendBtn.style.display = index===3 ? "block" : "none";
  
  document.getElementById("back-button").style.display = index>0 ? "block" : "none";

  if(index===1) loadStaffPage();
  if(index===2) initializeCalendar();
  if(index===3){
    sendBtn.disabled = false;
    sendBtn.classList.add("highlight");
  }
   const url = new URL(window.location);
  url.searchParams.set("pageId", pages[index]);
  history.replaceState(null, "", url.toString());
}

menuNextBtn.addEventListener("click",()=>showPage(1));
staffNextBtn.addEventListener("click",()=>showPage(2));
document.getElementById("calendar-next").addEventListener("click",()=>showPage(3));
document.getElementById("back-button").addEventListener("click",()=>{if(currentPageIndex>0) showPage(currentPageIndex-1);});

// ---------- 初期ページ ----------
let pageIdParam = urlParams.get("pageId"); // URLからpageId取得
let initialPageIndex = 0; // デフォルトはメニュー画面
if(pageIdParam && pages.includes(pageIdParam)){
  initialPageIndex = pages.indexOf(pageIdParam);
}
showPage(initialPageIndex);


// ---------- メニュー ----------
let selectedMenuEl = null;
fetch(webhookURL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ webappurl: webappurl, userId: userId, menu: true,sheetId: sheetId })
})
.then(res=>res.json())
.then(data=>{
  menuContainer.innerHTML="";
  let lastBlock="";
  data.forEach(item=>{
    const block=item[0]||'', title=item[1]||'', desc=item[2]||'', price=item[5]||'', menuDuration=item[6]?parseInt(item[6],10):30;

	if(!title) return;	  
	  
    if(block!==lastBlock){
      const blockEl=document.createElement("div");
      blockEl.className="block-title"; blockEl.textContent=block; menuContainer.appendChild(blockEl);
      lastBlock=block;
    }
    const menuEl=document.createElement("div");
    menuEl.className="menu-item";
    menuEl.innerHTML=`<div class="menu-title">${title}（¥${price}）</div><div class="menu-desc">${desc}</div>`;
    menuEl.addEventListener("click",()=>{
      if(selectedMenuEl) selectedMenuEl.classList.remove("selected");
      menuEl.classList.add("selected");
      selectedMenuEl = menuEl;
      selectedMenu={メニュー名:title, 金額:price, duration:menuDuration};
      duration=menuDuration;
      menuNextBtn.disabled=false;
      menuNextBtn.classList.add("highlight");
    });
    menuContainer.appendChild(menuEl);
  });
}).catch(()=>{menuContainer.innerHTML="メニュー取得失敗";});

// ---------- スタッフ ----------
let selectedStaffEl = null;

function loadStaffPage() {
  staffContainer.innerHTML = "読み込み中...";
  fetch(webhookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ webappurl: webappurl, userId: userId, staff: true,sheetId: sheetId })
  })
  .then(res => res.json())
  .then(data => {
    staffContainer.innerHTML = "";
    data.forEach(staff => {
      const nickName = staff.nickName || "";
      const intro     = staff.introduction || "";
      const imageUrl  = staff.photo || "";
      const skill     = staff.skill || "";
      const fee       = staff.fee || "";
      const image     = staff.image || "";

      // 各ブロックごとに空欄なら display:none
      const skillDisplay = skill ? "block" : "none";
      const imageDisplay = image ? "block" : "none";
      const feeDisplay   = fee && Number(fee) > 0 ? "block" : "none";
      const introDisplay = intro ? "block" : "none";

      const card = document.createElement("div");
      card.className = "staff-card";
      card.innerHTML = `
        <img src="${imageUrl}" class="staff-photo" alt="スタッフ写真">
        <div class="staff-info">
          <div class="nickName" style="display:${skillDisplay}">${nickName}</div>

          <div class="block-label" style="display:${skillDisplay}">得意な技術</div>
          <div class="staff-skill" style="display:${skillDisplay}">　${skill}</div>

          <div class="block-label" style="display:${imageDisplay}">得意なイメージ</div>
          <div class="staff-image" style="display:${imageDisplay}">　${image}</div>

          <div class="block-label" style="display:${feeDisplay}">指名料</div>
          <div class="staff-fee" style="display:${feeDisplay}">　${feeDisplay === "block" ? "¥" + fee : ""}</div>

          <div class="block-label" style="display:${introDisplay}">紹介文</div>
          <div class="introduction" style="display:${introDisplay}">　${intro}</div>
        </div>
      `;

      card.addEventListener("click", () => {
        if(selectedStaffEl) selectedStaffEl.classList.remove("selected");
        card.classList.add("selected");
        selectedStaffEl = card;
        selectedStaff = {
          nickName: nickName,
          skill: skill,
          image: image,
          fee: fee,
          photo: imageUrl,
          introduction: intro
        };
        staffNextBtn.disabled = false;
        staffNextBtn.classList.add("highlight");
      });

      staffContainer.appendChild(card);
    });
  })
  .catch(() => {
    staffContainer.innerHTML = "スタッフ取得失敗";
  });
}


// ---------- カレンダー ----------
function getTodayJST(){ const now=new Date(); const utc=now.getTime()+now.getTimezoneOffset()*60000; return new Date(utc+9*3600000);}

function initializeCalendar(){

let data = {
		    webappurl: webappurl,
		    userId: userId,
		  	sheetId: sheetId,
		    duration: duration,
		    getReserve: true,
		    staff: selectedStaff?.nickName || ""
  };

	if (isHenkou) {
	  data.eventHenkou = true;
	}

const today=getTodayJST();
  displayedYear=today.getFullYear(); displayedMonth=today.getMonth();
fetch(webhookURL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(data)
})
  .then(res=>res.json())
.then(data => {
  if (data.businessHours) {
    const bh = data.businessHours;
    startHour   = parseInt(bh.startHour, 10) || 9;
    startMinute = parseInt(bh.startMinute, 10) || 0;
    endHour     = parseInt(bh.endHour, 10) || 18;
    endMinute   = parseInt(bh.endMinute, 10) || 0;
    reservedSlots = data.reservedSlots || [];
    buildCalendar(displayedYear, displayedMonth);
  }
  }).catch(()=>{
    startHour   = 9;
    startMinute = 0;
    endHour     = 18;
    endMinute   = 0;
    reservedSlots = [];
    buildCalendar(displayedYear, displayedMonth);
  });

}


function buildCalendar(year,month){
const today=getTodayJST();
  calendarDiv.innerHTML="";
  const dayNames=["日","月","火","水","木","金","土"];
  dayNames.forEach(dn=>{const dnElem=document.createElement("div"); dnElem.className="day-name"; dnElem.textContent=dn; calendarDiv.appendChild(dnElem);});
  const firstDay=new Date(year,month,1), lastDay=new Date(year,month+1,0);
  const firstWeekDay=firstDay.getDay(), daysInMonth=lastDay.getDate();
  for(let i=0;i<firstWeekDay;i++){ const emptyDiv=document.createElement("div"); emptyDiv.className="day inactive"; calendarDiv.appendChild(emptyDiv);}
  for(let d=1;d<=daysInMonth;d++){
    const dayDiv=document.createElement("div"); dayDiv.className="day"; dayDiv.textContent=d;
    const dayDate=new Date(year,month,d);
    const todayDateOnly=new Date(today.getFullYear(),today.getMonth(),today.getDate());
    if(dayDate<todayDateOnly) dayDiv.classList.add("inactive");
    dayDiv.dataset.date=`${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    dayDiv.addEventListener("click",()=>onDateSelected(dayDiv));
    calendarDiv.appendChild(dayDiv);
  }
  currentMonthLabel.textContent=`${year}年${month+1}月`;
  if(selectedDayDiv) selectedDayDiv.classList.remove("selected"); selectedDayDiv=null;
  timesList.style.display="none"; 
  selectedInfo.textContent="予約したい日時を選択してください"; sendBtn.disabled=true;
}

function onDateSelected(dayDiv){
  if(dayDiv.classList.contains("inactive")) return;
  if(selectedDayDiv) selectedDayDiv.classList.remove("selected");
  dayDiv.classList.add("selected"); selectedDayDiv=dayDiv;
  showTimeSlots(dayDiv.dataset.date);
}

prevBtn.addEventListener("click",()=>{
  if(displayedMonth===0){ displayedMonth=11; displayedYear--; } else displayedMonth--;
  buildCalendar(displayedYear,displayedMonth);
});
nextBtn.addEventListener("click",()=>{
  if(displayedMonth===11){ displayedMonth=0; displayedYear++; } else displayedMonth++;
  buildCalendar(displayedYear,displayedMonth);
});



















/**
function showTimeSlots(dateStr){
  slotsContainer.innerHTML=""; timesList.style.display="block"; selectedInfo.textContent="時間を選択してください"; sendBtn.disabled=true;
  const baseDate=new Date(dateStr+"T00:00:00+09:00");
  let current=new Date(baseDate); current.setHours(startHour,startMinute,0,0);
  const end=new Date(baseDate); end.setHours(endHour,endMinute,0,0);
  const reservedForDay=reservedSlots.filter(slot=>new Date(slot.start).toISOString().slice(0,10)===dateStr);
  let selectedTimeDiv=null;
    
//残業確定でスロット生成してるので、90分予約でも営業終了時間までスロット生成可能にしているが、残業を考慮しない、営業終了時間までとするならば「=」をけすだけでいい
 while(current<=end){   

 
    const slotEnd = new Date(current.getTime() + duration*60000);
    const isReserved=reservedForDay.some(slot=>{const s=new Date(slot.start),e=new Date(slot.end); return !(slotEnd<=s||current>=e);});
    const timeDiv=document.createElement("div"); timeDiv.className="time-slot";
    if(isReserved) timeDiv.classList.add("unavailable");
    const hh=String(current.getHours()).padStart(2,"0"), mm=String(current.getMinutes()).padStart(2,"0");
    timeDiv.textContent=`${hh}:${mm}`;
    if(!isReserved){
      timeDiv.addEventListener("click",()=>{
        if(selectedTimeDiv) selectedTimeDiv.classList.remove("selected");
        timeDiv.classList.add("selected"); selectedTimeDiv=timeDiv;
        selectedInfo.textContent=`選択中: ${dateStr} ${timeDiv.textContent}`;
		sendBtn.classList.add("highlight");
document.getElementById("calendar-next").disabled = false;
document.getElementById("calendar-next").classList.add("highlight");
      });
    }
    slotsContainer.appendChild(timeDiv);
    current=new Date(current.getTime()+30*60000);
  }
}

*/



function showTimeSlots(dateStr){
  slotsContainer.innerHTML = "";
  timesList.style.display = "block";
  selectedInfo.textContent = "時間を選択してください";
  sendBtn.disabled = true;

  const baseDate = new Date(dateStr + "T00:00:00+09:00");
  let current = new Date(baseDate);
  current.setHours(startHour, startMinute, 0, 0);
  const end = new Date(baseDate);
  end.setHours(endHour, endMinute, 0, 0);
  let selectedTimeDiv = null;

  // 変更点1: reservedSlots の日付変換をループ外でまとめる
  const reservedForDay = reservedSlots
    .map(slot => ({
      start: new Date(slot.start).getTime(),
      end: new Date(slot.end).getTime()
    }))
    .filter(slot => {
      const slotDate = new Date(slot.start);
      return slotDate.getFullYear() === baseDate.getFullYear() &&
             slotDate.getMonth() === baseDate.getMonth() &&
             slotDate.getDate() === baseDate.getDate();
    });

  // 変更点2: DocumentFragment を使ってまとめて DOM 追加
  const fragment = document.createDocumentFragment();

  while(current <= end){
    const slotEndTime = current.getTime() + duration * 60000;
    const isReserved = reservedForDay.some(slot => !(slotEndTime <= slot.start || current.getTime() >= slot.end));

    const timeDiv = document.createElement("div");
    timeDiv.className = "time-slot";
    if(isReserved) timeDiv.classList.add("unavailable");

    const hh = String(current.getHours()).padStart(2,"0");
    const mm = String(current.getMinutes()).padStart(2,"0");
    timeDiv.textContent = `${hh}:${mm}`;

    if(!isReserved){
      timeDiv.addEventListener("click", () => {
        if(selectedTimeDiv) selectedTimeDiv.classList.remove("selected");
        timeDiv.classList.add("selected");
        selectedTimeDiv = timeDiv;
        selectedInfo.textContent = `選択中: ${dateStr} ${timeDiv.textContent}`;
        sendBtn.classList.add("highlight");
        document.getElementById("calendar-next").disabled = false;
        document.getElementById("calendar-next").classList.add("highlight");
      });
    }

    fragment.appendChild(timeDiv);
    current = new Date(current.getTime() + 30*60000);
  }

  slotsContainer.appendChild(fragment);
}

































// ---------- 送信 ----------
sendBtn.addEventListener("click", async () => {
  if (!userId || !selectedStaff || !selectedDayDiv) { 
    alert("予約情報が不完全です"); 
    return; 
  }

  const selectedTimeText = document.querySelector(".time-slot.selected")?.textContent;
  if (!selectedTimeText) { 
    alert("時間を選択してください"); 
    return; 
  }

  // ★ ここで送信中に切り替え
  sendBtn.disabled = true;
  const originalText = sendBtn.textContent;
  sendBtn.textContent = "予約送信中です。お待ちください";

  const dateStr = selectedDayDiv.dataset.date;
  const startDateTime = new Date(`${dateStr}T${selectedTimeText}:00+09:00`);
  const endDateTime = new Date(startDateTime.getTime() + duration * 60000);
  
  const requestText = document.getElementById("request-text").value.trim();

  let data = {
		  webappurl: webappurl,
		  sheetId: sheetId,
		  reservation: {
			  userId: userId,
			  menu: selectedMenu,
			  staff: selectedStaff,
			  start: startDateTime.toISOString(),
			  end: endDateTime.toISOString(),
			  youbou: requestText
		  }
  };

	if (isHenkou) {
	  data.eventHenkou = true;
	} else {
	  data.kakutei = true;
	}
	
  try {
	const res = await fetch(postwebhookURL, {
	  method: "POST",
	  headers: { "Content-Type": "application/json" },
	  body: JSON.stringify(data)
});

    if (!res.ok) throw new Error("送信失敗");

    // 成功した場合は完了画面に遷移
    completionPage.style.display = "flex";
	pages.forEach(p => document.getElementById(p).style.display = "none"); // ← 追加
    document.getElementById("calendar-page").style.display = "none";
    document.querySelector(".action-bar").style.display = "none";

  } catch (err) {
    alert(`送信エラー: ${err.message}`);
    // 失敗した場合はボタンを元に戻す
    sendBtn.disabled = false;
    sendBtn.textContent = originalText;
  }
});
};

</script>

</body>
</html>
