<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- ← これがあるとスマホでも綺麗に見える！ -->
<title>カラーテーマ選択</title>
<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  gap: 20px;
  margin: 20px;
  background-color: #f0f2f5;
}
#backBtn {
  padding: 6px 10px;
  font-size: 13px;
  background-color: #cccccc;
  color: #333;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  align-self: flex-start; /* 左上に配置 */
}
#backBtn:hover {
  background-color: #aaaaaa;
}
.controls {
  display: flex;
  flex-direction: column;
  flex: 0 0 35%;
  padding: 20px;
  border: 1px solid #ccc;
  border-radius: 10px;
  background-color: #fff;
  box-sizing: border-box;
  height: 90vh;
}
.color-list {
  flex: 1;
  overflow-y: auto;
  padding-right: 5px;
}
h3 {
  margin-bottom: 15px;
  color: #333;
  text-align: center;
}
h4 {
  margin: 15px 0 5px;
  color: #555;
  border-bottom: 1px solid #ddd;
  padding-bottom: 3px;
}
.color-row {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
}
.color-row span {
  margin-left: 10px;
  margin-right: 10px;
  white-space: nowrap;
  font-weight: normal;
  font-size: 13px;
}
.color-row input[type="color"] {
  width: 50px;
  height: 28px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-left: auto;
}
button {
  padding: 10px 15px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background-color: #3399cc;
  color: #fff;
  font-weight: bold;
  transition: background-color 0.2s;
}
button:hover { background-color: #287bb5; }
button:disabled { opacity: 0.6; cursor: not-allowed; }
.action-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #ddd;
  background: #f9f9f9;
}
iframe {
  flex: 1;
  height: 90vh;
  border: 1px solid #333;
  border-radius: 10px;
}
#error-message {
  display: none;
  color: red;
  margin-top: 10px;
}
select {
  width: 100%;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
  background-color: #fff;
  cursor: pointer;
}
.btn-link {
  padding:4px 8px;
  font-size:12px;
  background-color:#3399cc;
  color:#fff;
  border-radius:4px;
  text-decoration:none;
  cursor:pointer;
}
/* 背景画像の適用ボタンの調整 */
#applyBtn {
  padding: 5px 8px;           /* 開くボタンと同じくらいの小さめサイズ */
  font-size: 12px;            /* 開くボタンに合わせる */
  background-color: #287bb5;  /* 少し色を変える */
  color: #fff;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  margin-left: 20px;           /* 開くボタンとの間隔 */
  transition: background-color 0.2s;
}
#applyBtn:hover {
  background-color: #1f5f8a;  /* ホバー時の色も少し濃く */
}

/* 折りたたみ見出しの装飾 */
.toggle-section {
  display: flex;
  align-items: center;
  cursor: pointer;
  user-select: none;
}

.toggle-btn {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 1px solid #888;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-right: 8px;
  font-size: 14px;
  background: #f7f7f7;
  transition: 0.2s;
}
.toggle-btn:hover {
  background: #e0e0e0;
}

/* 折りたたみ対象ブロック */
.section-content {
  display: none;
  margin-left: 25px;
}

/* 展開時 */
.section-content.active {
  display: block;
}

/* スマホ表示（1024px以下）のときは縦並びにして操作パネルを上に */
@media (max-width: 1024px) {
  body {
    flex-direction: column;
    gap: 10px;
    height: auto;
    overflow-y: auto;
  }

  .controls {
    width: 100%;
    height: auto;
    order: 1;
  }

  #previewFrame {
    width: 100%;
    min-height: 80vh; /* 下まで見える */
    height: auto;
    max-height: none;
    order: 2;
  }
}

@media (max-width: 375px) {
  body {
    flex-direction: column;
    gap: 10px;
    height: auto;
    overflow-y: auto;
  }

  .controls {
    width: 100%;
    height: auto;
    order: 1;
  }

  #previewFrame {
    width: 100%;
    min-height: 70vh; /* 下まで見える */
    height: auto;
    max-height: none;
    order: 2;
  }
}
</style>
</head>
<body>

<div id="form-page" class="page active">
  <div class="controls">
    <button id="backBtn" type="button">← 戻る</button>
    <h3>予約フォーム</h3>
    <div class="color-list">
      <form id="customer-form" class="page active">
        <h4>スタイルの見た目</h4>
        <select id="styleSelect">
          <option value="style.css">水色系</option>
          <option value="style_huwa.css">ピンク系</option>
          <option value="style_luxury.css">ラグジュアリー系</option>
        </select>
		
			<!-- 背景画像 -->
			<div class="toggle-section">
			  <div class="toggle-btn">＋</div>
			  <h4>背景画像</h4>
			</div>
			<div class="section-content">
			  <div class="color-row">
				<span>背景画像設定：</span>
				<a id="bgImageLink" target="_blank" class="btn-link">開く</a>
				<button type="button" id="applyBtn">適用</button>
			  </div>
			</div>
			
			<!-- 全体に関して -->
			<div class="toggle-section">
			  <div class="toggle-btn">＋</div>
				<h4>全体に関して</h4>
			</div>
			<div class="section-content">
				<div class="color-row"><span>タイトル・完了ページ： </span><input type="color" id="colorHeading" value="#4a4a4a"><br></div>
				<div class="color-row"><span>選択肢・枠線等の色： </span><input type="color" id="bgSelected" value="#7fcfff"> <br></div>
				<div class="color-row"><span>各種カードと月のボタン色： </span><input type="color" id="bgCardCommon" value="#0f0f0f"><br></div>
				<div class="color-row"><span>日付と時間スロットの文字色： </span><input type="color" id="colorSlotStringCommon" value="#000000"><br></div>		
			</div>				
				
			<!-- ボタン -->
			<div class="toggle-section">
			  <div class="toggle-btn">＋</div>
				<h4>ボタン</h4>
			</div>
			<div class="section-content">
				<div class="color-row"><span>文字色： </span><input type="color" id="colorButtonString" value="#000000"><br></div>
				<div class="color-row"><span>選択前・ボタンの色： </span><input type="color" id="bgDisabledButton" value="#cccccc"><br></div>
				<div class="color-row"><span>選択後・ボタンの色： </span><input type="color" id="bgHighlight" value="#a3d9ff"> <br>
				</div>
			</div>				
				
			<!-- メニュー画面 -->
			<div class="toggle-section">
			  <div class="toggle-btn">＋</div>
				<h4>メニュー画面</h4>
			</div>
			<div class="section-content">
				<div class="color-row"><span>ブロック名：</span><input type="color"id="colorBlockTitle"value="#000000"><br></div>
				<div class="color-row"><span>メニュー名：</span><input type="color"id="colorMenuItemString"value="#000000"><br></div>
				<div class="color-row"><span>メニュー説明：</span><input type="color"id="colorMenuDescString"value="#424242"><br></div>
			</div>
				
			<!-- スタッフ画面 -->
			<div class="toggle-section">
			  <div class="toggle-btn">＋</div>
				<h4>スタッフ画面</h4>
			</div>
			<div class="section-content">
				<div class="color-row"><span>スタッフ名：</span><input type="color"id="colorStaffName"value="#000000"><br></div>
				<div class="color-row"><span>得意な技術・指名料・紹介文：</span><input type="color"id="colorStaffLabel"value="#000000"><br></div>
				<div class="color-row"><span>得意な技術・指名料・紹介文の説明：</span><input type="color"id="colorStaffExp"value="#000000"><br></div>
			</div>				

			<!-- カレンダー画面 -->
			<div class="toggle-section">
			  <div class="toggle-btn">＋</div>
				<h4>カレンダー画面</h4>
			</div>
			<div class="section-content">
				<div class="color-row"><span>曜日スロットの文字色：</span><input type="color"id="colorDayString"value="#ffffff"><br></div>
				<div class="color-row"><span>時間スロットの背景色：</span><input type="color"id="bgTimeSlot"value="#dcfce7"><br></div>
				<div class="color-row"><span>選択不可の時間スロットの背景色：</span><input type="color"id="bgUnavailableSlots"value="#e2e8f0"><br><br></div>
			</div>				
				
      </form>
    </div>

    <div class="action-buttons">
      <button type="submit" form="customer-form" id="submitBtn">保存</button>
      <button type="button" id="resetBtn">リセット</button>
      <button type="button" id="initBtn">初期化</button>
    </div>
    <div id="error-message">送信できませんでした。もう一度お試しください。</div>
  </div>
</div>

<iframe id="previewFrame" src=""></iframe>

<script>
const form = document.getElementById("customer-form");
const errorMessage = document.getElementById("error-message");
const webhookURL = "https://reservations.demover222.workers.dev/";
const params = new URLSearchParams(window.location.search);
const webappurl = params.get("webappurl");
const sheetId = params.get("sheetId");                                                                                                                                                       //変更

let fetchedColors = {};
let bgimageCache = "";

const styleDefaults = {
		"style.css": {
			colorHeading: "#4a4a4a",
			bgSelected: "#7fcfff",
			bgCardCommon: "#f0f0f0",
			colorSlotStringCommon: "#000000",
			colorButtonString: "#000000",
			bgDisabledButton: "#cccccc",
			bgHighlight: "#a3d9ff",
			colorBlockTitle: "#000000",
			colorMenuItemString: "#000000",
			colorMenuDescString: "#424242",
			colorStaffName: "#000000",
			colorStaffLabel: "#000000",
			colorStaffExp: "#000000",
			colorDayString: "#ffffff",
			bgTimeSlot: "#dcfce7",
			bgUnavailableSlots: "#e2e8f0"
		},
		"style_huwa.css": {
			colorHeading: "#4a4a4a",
			bgSelected: "#fabaff",
			bgCardCommon: "#f0f0f0",
			colorSlotStringCommon: "#000000",
			colorButtonString: "#000000",
			bgDisabledButton: "#cccccc",
			bgHighlight: "#f6c7d6",
			colorBlockTitle: "#000000",
			colorMenuItemString: "#000000",
			colorMenuDescString: "#424242",
			colorStaffName: "#000000",
			colorStaffLabel: "#000000",
			colorStaffExp: "#000000",
			colorDayString: "#ffffff",
			bgTimeSlot: "#dcfce7",
			bgUnavailableSlots: "#e2e8f0"
		},
		"style_luxury.css": {
			colorHeading: "#d4af37",
			bgSelected: "#f7ed21",
			bgCardCommon: "#f0f0f0",
			colorSlotStringCommon: "#000000",
			colorButtonString: "#000000",
			bgDisabledButton: "#cccccc",
			bgHighlight: "#f1d77e",
			colorBlockTitle: "#d4af37",
			colorMenuItemString: "#000000",
			colorMenuDescString: "#424242",
			colorStaffName: "#000000",
			colorStaffLabel: "#000000",
			colorStaffExp: "#000000",
			colorDayString: "#ffffff",
			bgTimeSlot: "#dcfce7",
			bgUnavailableSlots: "#e2e8f0"
		}
};


function updateIframe(colors, bgimage="") {
  const iframe = document.getElementById("previewFrame");

  // 最新の pageId を取得
  let pageId = "";
  try {
    const urlObj = new URL(iframe.contentWindow.location.href);
    pageId = urlObj.searchParams.get("pageId") || "";
  } catch(err) {
    console.warn("pageId 取得できません（同一オリジンか確認してください）", err);
  }
  
  let url = "https://demover222-1.github.io/tougou/?userId=test" +                                                                                                  //変更
			"&sheetId=" + sheetId +		
			"&webappurl=" + webappurl +
			"&colorHeading=" + encodeURIComponent(colors.colorHeading) +
			"&bgSelected=" + encodeURIComponent(colors.bgSelected) +
			"&bgCardCommon=" + encodeURIComponent(colors.bgCardCommon) + "D9" +
			"&colorSlotStringCommon=" + encodeURIComponent(colors.colorSlotStringCommon) +
			"&colorButtonString=" + encodeURIComponent(colors.colorButtonString) +
			"&bgDisabledButton=" + encodeURIComponent(colors.bgDisabledButton) +
			"&bgHighlight=" + encodeURIComponent(colors.bgHighlight) +
			"&colorBlockTitle=" + encodeURIComponent(colors.colorBlockTitle) +
			"&colorMenuItemString=" + encodeURIComponent(colors.colorMenuItemString) +
			"&colorMenuDescString=" + encodeURIComponent(colors.colorMenuDescString) +
			"&colorStaffName=" + encodeURIComponent(colors.colorStaffName) +
			"&colorStaffLabel=" + encodeURIComponent(colors.colorStaffLabel) +
			"&colorStaffExp=" + encodeURIComponent(colors.colorStaffExp) +
			"&colorDayString=" + encodeURIComponent(colors.colorDayString) +
			"&bgTimeSlot=" + encodeURIComponent(colors.bgTimeSlot) +
			"&bgUnavailableSlots=" + encodeURIComponent(colors.bgUnavailableSlots) +
			"&css=" + encodeURIComponent(document.getElementById("styleSelect").value);
  if(bgimage.trim() !== "") url += "&bgimage=https://lh3.googleusercontent.com/d/" + encodeURIComponent(bgimage);
  if(pageId) url += "&pageId=" + pageId;
	
  document.getElementById("previewFrame").src = url;
  
}

function applyColorsToFormAndIframe(colors, bgimage="") {
  Object.keys(colors).forEach(k => { if(document.getElementById(k)) document.getElementById(k).value = colors[k]; });
  updateIframe(colors, bgimage);
}

function getColorsForStyle(style) {
  const defaults = styleDefaults[style] || styleDefaults["style.css"];
  const colors = {};
  for (let key in defaults) {
    const val = fetchedColors[key] || "#fffffe";
    colors[key] = (val.toLowerCase() === "#fffffe") ? defaults[key] : val;
  }
  return colors;
}

window.onload = function() {
  const bgImageLink = document.getElementById("bgImageLink");
  if(webappurl) bgImageLink.href = webappurl;
  fetch(webhookURL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ webappurl: webappurl, getColorData:true, form:"tougou", sheetId: sheetId }) })                                       //変更
    .then(res => res.text())
    .then(text => {
      try { fetchedColors = JSON.parse(text); } catch(e){ fetchedColors = {}; }
      const selectedStyle = fetchedColors.selectedStyle || "style.css";
      document.getElementById("styleSelect").value = selectedStyle;
      bgimageCache = fetchedColors.bgimage || "";
      applyColorsToFormAndIframe(getColorsForStyle(selectedStyle), bgimageCache);
    }).catch(err=>console.error(err));
};

document.getElementById("applyBtn").addEventListener("click", () => {
  const btn = document.getElementById("applyBtn");
  const originalText = btn.textContent;
  btn.disabled=true; btn.textContent="更新中...";
  const selectedStyle = document.getElementById("styleSelect").value;
  const defaults = styleDefaults[selectedStyle] || styleDefaults["style.css"];
  const colors = {};
  document.querySelectorAll(".color-list input[type=color]").forEach(input=>{
    const val = input.value.toLowerCase();
    colors[input.id] = (val === "#fffffe") ? defaults[input.id] : val;
  });
  fetch(webhookURL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ webappurl: webappurl, getColorData:true, form:"tougou", sheetId: sheetId }) })                                       //変更
    .then(res=>res.text())
    .then(text=>{ try { const data = JSON.parse(text); bgimageCache=data.bgimage||""; } catch(e){ console.error(e); } })
    .finally(()=>{ updateIframe(colors, bgimageCache); btn.disabled=false; btn.textContent=originalText; });
});

document.getElementById("styleSelect").addEventListener("change", ()=>{
  applyColorsToFormAndIframe(getColorsForStyle(document.getElementById("styleSelect").value), bgimageCache);
});

document.getElementById("resetBtn").addEventListener("click", ()=>{
  const selectedStyle = fetchedColors.selectedStyle || "style.css";
  document.getElementById("styleSelect").value = selectedStyle;
  applyColorsToFormAndIframe(getColorsForStyle(selectedStyle), bgimageCache);
});

document.getElementById("initBtn").addEventListener("click", ()=>{
  const initBtn = document.getElementById("initBtn");
  const styleSelect = document.getElementById("styleSelect");
  if(!confirm("現在、選択・保存している色と背景画像が初期化されますが、よろしいですか？")) return;
  const originalText = initBtn.textContent;
  const selectedStyle = styleSelect.value;
  styleSelect.disabled=true; initBtn.disabled=true; initBtn.textContent="初期化中...";
  const defaults = styleDefaults[selectedStyle] || styleDefaults["style.css"];
  fetch(webhookURL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({ webappurl: webappurl, bgimageTougouDelete:true, form: "tougou", sheetId: sheetId }) })                                       //変更
    .then(res=>res.text()).then(()=>{ bgimageCache=""; fetchedColors = {};  applyColorsToFormAndIframe(defaults, bgimageCache); })
    .finally(()=>{ styleSelect.disabled=false; initBtn.disabled=false; initBtn.textContent=originalText; });
});

function collectColors() {
  const colors={};
  document.querySelectorAll(".color-list input[type=color]").forEach(input=>colors[input.id]=input.value);
  return colors;
}

form.addEventListener("submit", (e)=>{
  e.preventDefault();
  errorMessage.style.display="none";
  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled=true; submitBtn.textContent="送信中...";
  const colors = collectColors();
  const data = { colorApplyForm:true, webappurl: webappurl, selectedStyle:document.getElementById("styleSelect").value, ...colors, form: "tougou", sheetId: sheetId };                        　　　　　　　               //変更
  fetch(webhookURL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data) })
    .then(res=>res.text()).then(()=>alert("反映が完了しました"))
    .catch(()=>{ errorMessage.style.display="block"; })
    .finally(()=>{ submitBtn.disabled=false; submitBtn.textContent="保存"; });
});

document.querySelectorAll(".color-list input[type=color]").forEach(input=>{
  input.addEventListener("input", ()=>{
    updateIframe(collectColors(), bgimageCache);
  });
});

document.getElementById("backBtn").addEventListener("click", () => {
  window.location.href = "https://demover222-1.github.io/settei/settei.html?userId=test" +
      "&sheetId=" + sheetId +                                                                                                                                                                                              //変更
      "&webappurl=" + webappurl;
});

// 折りたたみ動作
document.querySelectorAll(".toggle-section").forEach(section => {
  const btn = section.querySelector(".toggle-btn");
  const content = section.nextElementSibling;

  btn.addEventListener("click", () => {
    const isActive = content.classList.toggle("active");
    btn.textContent = isActive ? "－" : "＋";
  });
});


</script>
</body>
</html>

