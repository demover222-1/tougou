<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>カラーテーマ選択</title>
<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  gap: 20px;
  margin: 20px;
  background-color: #f0f2f5;
  height: 100vh;
  box-sizing: border-box;
}

/* 左側のコントロールパネル */
.controls {
  display: flex;
  flex-direction: column;
  flex: 0 0 35%;
  padding: 20px;
  border: 1px solid #ccc;
  border-radius: 10px;
  background-color: #fff;
  box-sizing: border-box;
  height: 90vh;
}

#backBtn {
  padding: 6px 10px;
  font-size: 13px;
  background-color: #cccccc;
  color: #333;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  align-self: flex-start;
}
#backBtn:hover { background-color: #aaaaaa; }

.color-list {
  flex: 1;
  overflow-y: auto;
  padding-right: 5px;
}
h3 {
  margin-bottom: 15px;
  color: #333;
  text-align: center;
}
h4 {
  margin: 15px 0 5px;
  color: #555;
  border-bottom: 1px solid #ddd;
  padding-bottom: 3px;
}
.color-row {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
}
.color-row span {
  margin-left: 10px;
  margin-right: 10px;
  white-space: nowrap;
  font-weight: normal;
  font-size: 13px;
}
.color-row input[type="color"] {
  width: 50px;
  height: 28px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  margin-left: auto;
}

button {
  padding: 10px 15px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background-color: #3399cc;
  color: #fff;
  font-weight: bold;
  transition: background-color 0.2s;
}
button:hover { background-color: #287bb5; }
button:disabled { opacity: 0.6; cursor: not-allowed; }

.action-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #ddd;
  background: #f9f9f9;
}

iframe {
  flex: 1;
  height: 90vh;
  border: 1px solid #333;
  border-radius: 10px;
}

#error-message {
  display: none;
  color: red;
  margin-top: 10px;
}

select {
  width: 100%;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
  background-color: #fff;
  cursor: pointer;
}

.btn-link {
  padding:4px 8px;
  font-size:12px;
  background-color:#3399cc;
  color:#fff;
  border-radius:4px;
  text-decoration:none;
  cursor:pointer;
}

#applyBtn {
  padding: 5px 8px;
  font-size: 12px;
  background-color: #287bb5;
  color: #fff;
  border-radius: 4px;
  border: none;
  cursor: pointer;
  margin-left: 20px;
  transition: background-color 0.2s;
}
#applyBtn:hover { background-color: #1f5f8a; }

.toggle-section {
  display: flex;
  align-items: center;
  cursor: pointer;
  user-select: none;
}
.toggle-btn {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 1px solid #888;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-right: 8px;
  font-size: 14px;
  background: #f7f7f7;
  transition: 0.2s;
}
.toggle-btn:hover { background: #e0e0e0; }
.section-content { display: none; margin-left: 25px; }
.section-content.active { display: block; }

@media (max-width: 1024px) {
  body { flex-direction: column; gap: 10px; height: auto; overflow-y: auto; }
  .controls { width: 100%; height: auto; order: 1; }
  iframe { width: 100%; min-height: 80vh; height: auto; max-height: none; order: 2; }
}
@media (max-width: 375px) {
  body { flex-direction: column; gap: 10px; height: auto; overflow-y: auto; }
  .controls { width: 100%; height: auto; order: 1; }
  iframe { width: 100%; min-height: 70vh; height: auto; max-height: none; order: 2; }
}
</style>
</head>
<body>

<!-- 左側：カラーテーマコントロール -->
<div class="controls">
  <button id="backBtn" type="button">← 戻る</button>
  <h3>予約フォーム</h3>

  <div class="color-list">
    <form id="customer-form" class="page active">
      <!-- カラー設定フォームをここに配置 -->
    </form>
  </div>

  <div class="action-buttons">
    <button type="submit" form="customer-form" id="submitBtn">保存</button>
    <button type="button" id="resetBtn">リセット</button>
    <button type="button" id="initBtn">初期化</button>
  </div>

  <div id="error-message">送信できませんでした。もう一度お試しください。</div>
</div>

<!-- 右側：プレビュー用iframe -->
<iframe id="previewFrame" src=""></iframe>

<script>
const form = document.getElementById("customer-form");
const errorMessage = document.getElementById("error-message");
const webhookURL = "https://reservations.thinklayer.jp/";
const params = new URLSearchParams(window.location.search);
const webappurl = params.get("webappurl");
const sheetId = params.get("sheetId");

let fetchedColors = {};
let bgimageCache = "";

const styleDefaults = {
  "style.css": { colorHeading: "#4a4a4a", bgSelected: "#7fcfff", bgCardCommon: "#f0f0f0", colorSlotStringCommon: "#000000",
    colorButtonString: "#000000", bgDisabledButton: "#cccccc", bgHighlight: "#a3d9ff", colorBlockTitle: "#000000",
    colorMenuItemString: "#000000", colorMenuDescString: "#424242", colorStaffName: "#000000", colorStaffLabel: "#000000",
    colorStaffExp: "#000000", colorDayString: "#ffffff", bgTimeSlot: "#dcfce7", bgUnavailableSlots: "#e2e8f0" },
  "style_huwa.css": { colorHeading: "#4a4a4a", bgSelected: "#fabaff", bgCardCommon: "#f0f0f0", colorSlotStringCommon: "#000000",
    colorButtonString: "#000000", bgDisabledButton: "#cccccc", bgHighlight: "#f6c7d6", colorBlockTitle: "#000000",
    colorMenuItemString: "#000000", colorMenuDescString: "#424242", colorStaffName: "#000000", colorStaffLabel: "#000000",
    colorStaffExp: "#000000", colorDayString: "#ffffff", bgTimeSlot: "#dcfce7", bgUnavailableSlots: "#e2e8f0" },
  "style_luxury.css": { colorHeading: "#d4af37", bgSelected: "#f7ed21", bgCardCommon: "#f0f0f0", colorSlotStringCommon: "#000000",
    colorButtonString: "#000000", bgDisabledButton: "#cccccc", bgHighlight: "#f1d77e", colorBlockTitle: "#d4af37",
    colorMenuItemString: "#000000", colorMenuDescString: "#424242", colorStaffName: "#000000", colorStaffLabel: "#000000",
    colorStaffExp: "#000000", colorDayString: "#ffffff", bgTimeSlot: "#dcfce7", bgUnavailableSlots: "#e2e8f0" }
};

// iframeにスタイルを反映（リロード不要）
function updateIframeColors(colors) {
  const iframe = document.getElementById("previewFrame");
  try {
    const doc = iframe.contentDocument || iframe.contentWindow.document;
    if (!doc || !doc.body) return;

    const css = `
      body { color: ${colors.colorHeading || "#000"}; }
      .selected { background-color: ${colors.bgSelected || "#fff"}; }
      .card { background-color: ${colors.bgCardCommon || "#fff"}; }
      .slot { color: ${colors.colorSlotStringCommon || "#000"}; }
      button { color: ${colors.colorButtonString || "#fff"}; background-color: ${colors.bgDisabledButton || "#3399cc"}; }
      button.selected { background-color: ${colors.bgHighlight || "#3399cc"}; }
      .block-title { color: ${colors.colorBlockTitle || "#000"}; }
      .menu-item { color: ${colors.colorMenuItemString || "#000"}; }
      .menu-desc { color: ${colors.colorMenuDescString || "#000"}; }
      .staff-name { color: ${colors.colorStaffName || "#000"}; }
      .staff-label { color: ${colors.colorStaffLabel || "#000"}; }
      .staff-exp { color: ${colors.colorStaffExp || "#000"}; }
      .day-slot { color: ${colors.colorDayString || "#000"}; }
      .time-slot { background-color: ${colors.bgTimeSlot || "#fff"}; }
      .time-slot.unavailable { background-color: ${colors.bgUnavailableSlots || "#ccc"}; }
    `;

    let styleTag = doc.getElementById("dynamic-style");
    if (!styleTag) {
      styleTag = doc.createElement("style");
      styleTag.id = "dynamic-style";
      doc.head.appendChild(styleTag);
    }
    styleTag.textContent = css;
    doc.body.style.backgroundImage = bgimageCache ? `url('https://lh3.googleusercontent.com/d/${bgimageCache}')` : '';

  } catch (e) {
    console.warn("⚠️ iframe cross-origin制限によりDOMへアクセスできません:", e);
  }
}

// フォームの色入力に反映
function applyColorsToForm(colors, bgimage = "") {
  Object.keys(colors).forEach(k => {
    const el = document.getElementById(k);
    if (el) el.value = colors[k];
  });
  bgimageCache = bgimage;
  updateIframeColors(colors);
}

function collectColors() {
  const colors = {};
  document.querySelectorAll(".color-list input[type=color]").forEach(input => colors[input.id] = input.value);
  return colors;
}

// ✅ 初期ロード処理：fetchしてiframe表示
window.onload = async function() {
  const iframe = document.getElementById("previewFrame");
  const iframeUrl = `https://demover222-1.github.io/tougou/?userId=test&sheetId=${sheetId}&webappurl=${webappurl}`;
  iframe.src = iframeUrl;

  try {
    const res = await fetch(`${webhookURL}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ webappurl, getColorData: true, form: "tougou", sheetId })
    });

    const text = await res.text();
    fetchedColors = JSON.parse(text || "{}");

    const selectedStyle = fetchedColors.selectedStyle || "style.css";
    const bgimage = fetchedColors.bgimage || "";
    applyColorsToForm(getColorsForStyle(selectedStyle), bgimage);

    // iframe読み込み完了後に反映
    iframe.onload = () => {
      updateIframeColors(fetchedColors);
    };
  } catch (e) {
    console.error("カラー情報取得エラー:", e);
  }
};

// 色変更
document.querySelectorAll(".color-list input[type=color]").forEach(input => {
  input.addEventListener("input", () => updateIframeColors(collectColors()));
});

// スタイル選択変更
if (document.getElementById("styleSelect")) {
  document.getElementById("styleSelect").addEventListener("change", () => {
    applyColorsToForm(getColorsForStyle(document.getElementById("styleSelect").value), bgimageCache);
  });
}

// リセット・初期化
document.getElementById("resetBtn").addEventListener("click", () => {
  const selectedStyle = fetchedColors.selectedStyle || "style.css";
  applyColorsToForm(getColorsForStyle(selectedStyle), bgimageCache);
});

document.getElementById("initBtn").addEventListener("click", () => {
  if (!confirm("初期化してよろしいですか？")) return;
  const selectedStyle = document.getElementById("styleSelect")?.value || "style.css";
  const defaults = styleDefaults[selectedStyle] || styleDefaults["style.css"];
  bgimageCache = "";
  fetchedColors = {};
  applyColorsToForm(defaults, bgimageCache);
});

// 送信処理
form.addEventListener("submit", e => {
  e.preventDefault();
  errorMessage.style.display = "none";
  const btn = document.getElementById("submitBtn");
  btn.disabled = true; btn.textContent = "送信中...";

  const colors = collectColors();
  const data = { colorApplyForm: true, webappurl, selectedStyle: document.getElementById("styleSelect")?.value || "style.css", ...colors, form: "tougou", sheetId };

  fetch(webhookURL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) })
    .then(res => res.text())
    .then(() => alert("反映が完了しました"))
    .catch(() => errorMessage.style.display = "block")
    .finally(() => { btn.disabled = false; btn.textContent = "保存"; });
});

// 戻るボタン
document.getElementById("backBtn").addEventListener("click", () => {
  window.location.href = `https://demover222-1.github.io/settei/settei.html?userId=test&sheetId=${sheetId}&webappurl=${webappurl}`;
});

// 折りたたみ
document.querySelectorAll(".toggle-section").forEach(section => {
  const btn = section.querySelector(".toggle-btn");
  const content = section.nextElementSibling;
  btn.addEventListener("click", () => {
    const isActive = content.classList.toggle("active");
    btn.textContent = isActive ? "－" : "＋";
  });
});

// スタイル取得
function getColorsForStyle(style) {
  const defaults = styleDefaults[style] || styleDefaults["style.css"];
  const colors = {};
  for (let key in defaults) {
    const val = fetchedColors[key] || "#fffffe";
    colors[key] = (val.toLowerCase() === "#fffffe") ? defaults[key] : val;
  }
  return colors;
}
</script>

</body>
</html>

